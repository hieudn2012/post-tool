<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Auto login and post</title>
  <link rel="stylesheet" href="output.css">
</head>

<body>
  <div class="p-4">
    <div class="grid grid-cols-3 gap-4">
      <div>
        <input type="text" id="folder-input" class="w-full p-2 border-2 border-gray-200 rounded-md" readonly
          placeholder="Select folder working on">
        <button id="select-folder" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg mt-2">
          Select
        </button>

      </div>
    </div>
    <div class="mt-2 flex gap-2">
      <button id="import-accounts" class="bg-yellow-500 hover:bg-yellow-700 text-white font-bold py-2 px-4 rounded-lg">
        import accounts</button>
      <button id="import-posts" class="bg-yellow-500 hover:bg-yellow-700 text-white font-bold py-2 px-4 rounded-lg">
        import posts</button>
      <button id="preview-posts"
        class="bg-yellow-500 hover:bg-yellow-700 text-white font-bold py-2 px-4 rounded-lg">Preview
        posts</button>
    </div>
    <table class="w-full text-left border-collapse [&_td]:border [&_td]:p-4 [&_th]:border [&_th]:p-4 mt-5">
      <thead>
        <tr>
          <th>Index</th>
          <th>Proxy</th>
          <th>Account</th>
          <th>Time post</th>
          <th>Status</th>
          <th>Latest post</th>
          <th>Mode</th>
          <th></th>
        </tr>
      </thead>
      <tbody id="accountTable">
        <!-- Rows will be dynamically generated here -->
      </tbody>
    </table>
  </div>

  <script>
    // Generate table rows dynamically
    const tableBody = document.getElementById('accountTable');

    function loadAccounts(accounts) {
      // clear table
      tableBody.innerHTML = '';

      accounts.forEach(account => {
        const row = document.createElement('tr');

        // Index Column
        const indexCell = document.createElement('td');
        indexCell.textContent = account.id;
        row.appendChild(indexCell); 

        // Proxy Column
        const ipCell = document.createElement('td');
        ipCell.textContent = `${account.ip} || ${account.port} || ${account.user} || ${account.pass}`;
        row.appendChild(ipCell);

        // Account Column
        const accountCell = document.createElement('td');
        accountCell.textContent = `${account.account} || ${account.password} || ${account.account2fa}`;
        row.appendChild(accountCell);

        // Time post Column
        const timePostCell = document.createElement('td');
        timePostCell.classList.add('w-[200px]');
        // create an input element
        const timePostInput = document.createElement('input');
        timePostInput.setAttribute('type', 'number');
        timePostInput.setAttribute('placeholder', 'Time post');
        timePostInput.setAttribute('id', `time-post-${account.id}`);
        // set default value
        timePostInput.setAttribute('value', '0.5');
        timePostInput.classList.add('w-full', 'p-2', 'border-2', 'border-gray-200', 'rounded-md');
        timePostCell.appendChild(timePostInput);
        row.appendChild(timePostCell);

        // Status Column
        const statusCell = document.createElement('td');
        statusCell.textContent = 'Not logged in';
        // add id to status cell
        statusCell.setAttribute('id', `status-${account.id}`);
        row.appendChild(statusCell);

        // Latest post Column
        const latestPostCell = document.createElement('td');
        latestPostCell.setAttribute('id', `latest-post-${account.id}`);
        row.appendChild(latestPostCell);

        // Mode Column, add select element
        const modeCell = document.createElement('td');
        modeCell.classList.add('w-[200px]');
        const modeSelect = document.createElement('select');
        modeSelect.setAttribute('id', `mode-${account.id}`);
        modeSelect.value = 'hidden';
        modeSelect.classList.add('w-full', 'p-2', 'border-2', 'border-gray-200', 'rounded-md');
        modeSelect.innerHTML = `
          <option value="hidden">Hidden</option>
          <option value="brower">Browser</option>
        `;
        modeCell.appendChild(modeSelect);
        row.appendChild(modeCell);


        // Login Button Column
        const loginCell = document.createElement('td');
        const loginButton = document.createElement('button');
        loginButton.classList.add('bg-blue-500', 'hover:bg-blue-700', 'text-white', 'font-medium', 'py-2', 'px-4', 'rounded-lg', 'text-sm');
        loginButton.textContent = 'Login';
        loginButton.addEventListener('click', () => {
          // Trigger Puppeteer login for this account
          window.electronAPI.login(account);
        });

        // Run Button
        const runButton = document.createElement('button');
        runButton.setAttribute('id', `run-${account.id}`);
        runButton.classList.add('bg-green-500', 'hover:bg-green-700', 'text-white', 'font-medium', 'py-2', 'px-4', 'rounded-lg', 'text-sm');
        runButton.textContent = 'Run';
        runButton.addEventListener('click', () => {
          // Trigger Puppeteer run for this account
          const timePost = document.getElementById(`time-post-${account.id}`).value;
          const mode = document.getElementById(`mode-${account.id}`).value;
          window.electronAPI.run({ ...account, timePost: Number(timePost), headless: mode === 'hidden'  });
        });

        // Test Button
        const testButton = document.createElement('button');
        testButton.classList.add('bg-yellow-500', 'hover:bg-yellow-700', 'text-white', 'font-medium', 'py-2', 'px-4', 'rounded-lg', 'text-sm');
        testButton.textContent = 'Test';
        testButton.addEventListener('click', () => {
          // Trigger Puppeteer test for this account
          window.electronAPI.test(account);
        });

        // Setup Button
        const setupButton = document.createElement('button');
        setupButton.classList.add('bg-blue-500', 'hover:bg-blue-700', 'text-white', 'font-medium', 'py-2', 'px-4', 'rounded-lg', 'text-sm');
        setupButton.textContent = 'Setup';
        setupButton.addEventListener('click', () => {
          // Trigger Puppeteer setup for this account
          window.electronAPI.setup(account);
        });

        // Stop Button
        const stopButton = document.createElement('button');
        stopButton.classList.add('bg-red-500', 'hover:bg-red-700', 'text-white', 'font-medium', 'py-2', 'px-4', 'rounded-lg', 'text-sm');
        stopButton.textContent = 'Stop';
        stopButton.addEventListener('click', () => {
          // Trigger Puppeteer stop for this account
          window.electronAPI.stop(account);
        });

        // Save cookies Button
        const saveCookiesButton = document.createElement('button');
        saveCookiesButton.classList.add('bg-blue-500', 'hover:bg-blue-700', 'text-white', 'font-medium', 'py-2', 'px-4', 'rounded-lg', 'text-sm');
        saveCookiesButton.textContent = 'Save cookies';
        saveCookiesButton.addEventListener('click', () => {
          // Trigger Puppeteer save cookies for this account
          window.electronAPI.saveCookies(account);
        });

        // Load account Button
        const loadAccountButton = document.createElement('button');
        loadAccountButton.classList.add('bg-blue-500', 'hover:bg-blue-700', 'text-white', 'font-medium', 'py-2', 'px-4', 'rounded-lg', 'text-sm');
        loadAccountButton.textContent = 'Load account';
        loadAccountButton.addEventListener('click', () => {
          // Trigger Puppeteer load account for this account
          window.electronAPI.loadAccount(account);
        });

        // Copy 2fa Button
        const copy2faButton = document.createElement('button');
        copy2faButton.classList.add('bg-blue-500', 'hover:bg-blue-700', 'text-white', 'font-medium', 'py-2', 'px-4', 'rounded-lg', 'text-sm');
        copy2faButton.textContent = 'Get 2fa code';
        copy2faButton.addEventListener('click', () => {
          // Trigger Puppeteer copy 2fa for this account
          fetch(`https://2fa.live/tok/${account.account2fa}`)
            .then(response => response.json())
            .then(data => {
              navigator.clipboard.writeText(data.token);
            })
            .catch(error => {
              console.error('Error:', error);
            });
        });

        const actionContainer = document.createElement('div');
        actionContainer.classList.add('flex', 'gap-2', 'flex-wrap', 'w-[200px]');
        actionContainer.appendChild(testButton);
        actionContainer.appendChild(saveCookiesButton);
        actionContainer.appendChild(loadAccountButton);
        actionContainer.appendChild(copy2faButton);
        actionContainer.appendChild(stopButton);
        actionContainer.appendChild(setupButton);
        actionContainer.appendChild(loginButton);
        actionContainer.appendChild(runButton);
        loginCell.appendChild(actionContainer);
        row.appendChild(loginCell);

        tableBody.appendChild(row);
      });
    }

    // Listen for the result and update the DOM
    window.electronAPI.onActionResult((account) => {
      const statusCell = document.getElementById(`status-${account.id}`);
      statusCell.textContent = account.status;

      const runButton = document.getElementById(`run-${account.id}`);

      if (account.latestPost) {
        const latestPostCell = document.getElementById(`latest-post-${account.id}`);
        const date = new Date(account.latestPost.date);
        latestPostCell.textContent = date.toLocaleString();
      }

      if (account.retry || account.isNewRound) {
        runButton.click();
      }
    });

    document.getElementById('select-folder').addEventListener('click', async () => {
      const { path, accounts } = await window.electronAPI.selectFolder();
      document.getElementById('folder-input').value = path;
      loadAccounts(accounts);
    });

    // Load default
    window.electronAPI.loadDefault().then(({ accounts, path }) => {
      document.getElementById('folder-input').value = path;
      loadAccounts(accounts);
    });

    // Import accounts
    document.getElementById('import-accounts').addEventListener('click', async () => {
      const { accounts } = await window.electronAPI.importAccounts();
      loadAccounts(accounts);
    });

    // Import posts
    document.getElementById('import-posts').addEventListener('click', async () => {
      await window.electronAPI.importPosts();
    });

    // Preview posts
    document.getElementById('preview-posts').addEventListener('click', async () => {
      const posts = await window.electronAPI.previewPosts();
    });
  </script>
</body>

</html>